name: Release Desktop App

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-15          # Apple Silicon runner (arm64)
            platform: darwin
            arch: arm64
            server-binary: djinn-server-darwin-arm64
            server-ext: ''
            opencode-ext: ''
            eb-flag: --mac
          - os: ubuntu-latest
            platform: linux
            arch: x64
            server-binary: djinn-server-linux-x64
            server-ext: ''
            opencode-ext: ''
            eb-flag: --linux
          - os: windows-latest
            platform: win32
            arch: x64
            server-binary: djinn-server-win-x64.exe
            server-ext: .exe
            opencode-ext: .exe
            eb-flag: --win

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout public repo
        uses: actions/checkout@v4

      - name: Checkout private source
        uses: actions/checkout@v4
        with:
          repository: djinnos/cli
          token: ${{ secrets.CLI_REPO_TOKEN }}
          path: cli-source
          fetch-depth: 0

      - name: Extract version from tag
        id: version
        shell: bash
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      # --- Toolchain Setup ---

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache-dependency-path: |
            cli-source/apps/server/go.sum
            cli-source/apps/cli/go.sum

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Set up pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Set up Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      # --- Build djinn-server (Go, current platform only) ---

      - name: Build djinn-server (Unix)
        if: runner.os != 'Windows'
        working-directory: cli-source/apps/server
        run: |
          mkdir -p bin
          GOOS=${{ matrix.platform }} GOARCH=${{ matrix.arch == 'arm64' && 'arm64' || 'amd64' }} \
            go build -o bin/${{ matrix.server-binary }} ./cmd/djinn-server

      - name: Build djinn-server (Windows)
        if: runner.os == 'Windows'
        working-directory: cli-source/apps/server
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path bin
          $env:GOOS = "windows"
          $env:GOARCH = "amd64"
          go build -o bin/${{ matrix.server-binary }} ./cmd/djinn-server

      # --- Build OpenCode CLI (Bun compile, current platform only) ---

      - name: Install OpenCode dependencies
        working-directory: cli-source/packages/opencode
        run: bun install

      - name: Build OpenCode CLI (Unix)
        if: runner.os != 'Windows'
        working-directory: cli-source/packages/opencode/packages/opencode
        run: |
          # Symlink hoisted @opentui into package node_modules (build.ts uses relative ../node_modules/ import)
          ln -sf ../../../node_modules/@opentui node_modules/@opentui
          bun run build -- --single

      - name: Build OpenCode CLI (Windows)
        if: runner.os == 'Windows'
        working-directory: cli-source/packages/opencode/packages/opencode
        shell: pwsh
        run: |
          # Copy hoisted @opentui into package node_modules (symlinks unreliable on Windows)
          if (Test-Path node_modules/@opentui) { Remove-Item -Recurse -Force node_modules/@opentui }
          Copy-Item -Recurse ../../node_modules/@opentui node_modules/@opentui
          bun run build -- --single

      - name: Copy OpenCode binary to resources (Unix)
        if: runner.os != 'Windows'
        working-directory: cli-source
        run: |
          OPENCODE_DIST="packages/opencode/packages/opencode/dist"
          OPENCODE_RESOURCES="apps/desktop/resources/opencode"
          mkdir -p "$OPENCODE_RESOURCES"

          BUILT_DIR=$(ls -d "$OPENCODE_DIST"/opencode-* 2>/dev/null | head -1)
          if [ -z "$BUILT_DIR" ]; then
            echo "ERROR: No OpenCode build output found in $OPENCODE_DIST"
            ls -la "$OPENCODE_DIST" || true
            exit 1
          fi

          if [ "${{ matrix.platform }}" = "darwin" ]; then
            OPENCODE_BIN_NAME="opencode-cli-darwin-${{ matrix.arch }}"
          else
            OPENCODE_BIN_NAME="opencode-cli-linux-x64"
          fi

          cp "$BUILT_DIR/bin/opencode" "$OPENCODE_RESOURCES/$OPENCODE_BIN_NAME"
          chmod +x "$OPENCODE_RESOURCES/$OPENCODE_BIN_NAME"
          echo "Copied OpenCode binary: $OPENCODE_BIN_NAME"
          ls -la "$OPENCODE_RESOURCES/"

      - name: Copy OpenCode binary to resources (Windows)
        if: runner.os == 'Windows'
        working-directory: cli-source
        shell: pwsh
        run: |
          $dist = "packages/opencode/packages/opencode/dist"
          $resources = "apps/desktop/resources/opencode"
          New-Item -ItemType Directory -Force -Path $resources

          $builtDir = Get-ChildItem -Directory "$dist/opencode-*" | Select-Object -First 1
          if (-not $builtDir) {
            Write-Error "No OpenCode build output found in $dist"
            Get-ChildItem $dist -ErrorAction SilentlyContinue
            exit 1
          }

          Copy-Item "$($builtDir.FullName)/bin/opencode.exe" "$resources/opencode-cli-win-x64.exe"
          Write-Host "Copied OpenCode binary: opencode-cli-win-x64.exe"
          Get-ChildItem $resources

      # --- Copy server binary to desktop resources ---

      - name: Copy server binary to resources (Unix)
        if: runner.os != 'Windows'
        working-directory: cli-source
        run: |
          mkdir -p apps/desktop/resources/server
          cp apps/server/bin/${{ matrix.server-binary }} apps/desktop/resources/server/
          chmod +x apps/desktop/resources/server/${{ matrix.server-binary }}
          ls -la apps/desktop/resources/server/

      - name: Copy server binary to resources (Windows)
        if: runner.os == 'Windows'
        working-directory: cli-source
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path apps/desktop/resources/server
          Copy-Item "apps/server/bin/${{ matrix.server-binary }}" apps/desktop/resources/server/
          Get-ChildItem apps/desktop/resources/server/

      # Note: OpenCode App UI is built automatically by build.ts during
      # the OpenCode CLI build step above (embedded into the binary via $bunfs)

      # --- Build & Package Electron App ---

      - name: Install desktop dependencies
        working-directory: cli-source
        run: pnpm install

      - name: Set version in package.json
        working-directory: cli-source/apps/desktop
        run: npm version ${{ steps.version.outputs.VERSION }} --no-git-tag-version --allow-same-version

      - name: Build Electron app
        working-directory: cli-source/apps/desktop
        run: pnpm build

      - name: Package Electron app
        working-directory: cli-source/apps/desktop
        run: npx electron-builder ${{ matrix.eb-flag }} --${{ matrix.arch }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # --- Upload artifacts ---

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: desktop-${{ matrix.platform }}-${{ matrix.arch }}
          path: |
            cli-source/apps/desktop/dist/*-${{ matrix.arch }}.dmg
            cli-source/apps/desktop/dist/*-${{ matrix.arch }}.zip
            cli-source/apps/desktop/dist/*.AppImage
            cli-source/apps/desktop/dist/*.deb
            cli-source/apps/desktop/dist/*.exe
          if-no-files-found: error

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: List artifacts
        run: find artifacts -type f | sort

      - name: Create checksums
        working-directory: artifacts
        run: |
          sha256sum *.dmg *.zip *.AppImage *.deb *.exe 2>/dev/null > checksums.txt || true
          cat checksums.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
